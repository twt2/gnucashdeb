#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

package=gnucash

# need IEEE-compatibility flag on Alpha
DEB_HOST_ARCH := $(shell dpkg-architecture -qDEB_HOST_ARCH)
ifeq ($(DEB_HOST_ARCH),alpha)
  CFLAGS += -mieee
endif
ifeq ($(DEB_HOST_ARCH),hppa)
  CFLAGS += -ffunction-sections
endif

export SED=sed
export GCONF_DISABLE_MAKEFILE_SCHEMA_INSTALL=1

include /usr/share/dpatch/dpatch.make

configure: configure-stamp
configure-stamp:
	dh_testdir
	$(checkdir)
	env LDFLAGS="-L/usr/X11R6/lib" GUILE=/usr/bin/guile-1.6 CFLAGS="$(CFLAGS)" ./configure --disable-static --enable-ofx --enable-aqbanking --enable-hbci --enable-python-bindings --enable-locale-specific-tax --sysconfdir=/etc --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --libexecdir=/usr/lib --libdir=/usr/lib/gnucash --disable-error-on-warning --with-qt3-wizard-package=libaqbanking29-plugins-qt
	touch configure-stamp

build: patch build-stamp
build-stamp: configure-stamp
	dh_testdir
	# dh_testroot
	dh_clean -k
	dh_installdirs
	make
	# GUILE_WARN_DEPRECATED=no make check
	# touch build
	touch build-stamp

clean: unpatch
	dh_testdir
	dh_testroot
	[ ! -e Makefile ] || $(MAKE) clean
	rm -f configure-stamp build-stamp install-stamp config.log config.cache config.status
	rm -f po/*.gmo src/gnome/gnucash src/gnome/g-wrapped
	rm -f po/.intltool-merge-cache
	rm -f `find . -name "*.o"`
	rm -f `find . -name "*.lo"`
	rm -f `find . -name "*.a"`
	rm -f `find . -name ".scm-links"`
	rm -f `find . -name ".links"`
	rm -rf `find . -type d -name ".libs"`
	rm -rf `find . -type d -name ".deps"`
	rm -f  `find . -type l -name "gnucash"`
	rm -f  `find . -type l -name "g-wrapped"`
	rm -f  `find . -type l -name "goffice"`
	rm -f  `find . -type l -name "gsf"`
	rm -f src/report/report-gnome/report src/register/register-core/register src/import-export/binary-import/import-export
	# -rm doc/sgml/*/gnucash/help-search-index.db doc-tools/dbadd
	# -rm src/gnome/gnucash src/gnome/g-wrapped doc/sgml/C/help-search-index.db
	rm -f doc/sgml/C/help-search-index.db
	dh_clean

install: install-stamp
install-stamp: build-stamp
	dh_testdir
	dh_testroot
	dh_clean -k
	# make install prefix=`pwd`/debian/tmp/usr GNC_CONFIGDIR=`pwd`/debian/tmp/etc/gnucash infodir=`pwd`/debian/tmp/usr/share/info libdir=`pwd`/debian/tmp/usr/lib/gnucash
	# make install DESTDIR=`pwd`/debian/tmp
	LIBRARY_PATH=`pwd`/debian/tmp/usr/lib/gnucash:`pwd`/debian/tmp/usr/lib/gnucash/gnucash make install DESTDIR=`pwd`/debian/tmp
	# strip `find debian/tmp -name "*.so"`
	-rm -rf debian/tmp/home
	-rm -f debian/tmp/usr/share/info/dir*
#	convert debian/tmp/usr/share/gnucash/pixmaps/gnucash-icon.png debian/tmp/usr/share/gnucash/pixmaps/gnucash-icon.xpm
#	rm debian/tmp/usr/share/gnucash/pixmaps/gnucash-icon.png

	touch install-stamp

binary-indep: build install
	dh_testdir
	dh_testroot
	dh_install -i --sourcedir=debian/tmp
	rm debian/gnucash-common/usr/share/applications/gnucash.desktop
	dh_installdocs -i
	dh_installmanpages -i
	dh_installchangelogs -i ChangeLog
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

binary-arch: build install
	dh_testdir
	dh_testroot
	dh_install -a --sourcedir=debian/tmp
	dh_installexamples -a doc/examples/*.xac
	#
	# cp src/backend/postgres/README debian/gnucash-sql/usr/share/doc/gnucash-sql/README.sql
	#
	dh_installdocs -a
	dh_installmenu
# dh_perl not needed since the two perl dependencies already depend on perl
#	dh_perl
	dh_installchangelogs -a ChangeLog
	dh_gconf -a
	dh_strip -a --dbg-package=gnucash-dbg
	dh_desktop -a
	dh_compress -a
	dh_fixperms -a
	dh_installdeb -a
	dh_makeshlibs -a
	dh_shlibdeps -a -ldebian/gnucash/usr/lib/gnucash:debian/gnucash/usr/lib/gnucash/gnucash
	# sed -e "s/ gnucash,//" debian/substvars > debian/substvars.tmp
	# sed -e "s/libgwrapguile1/libgwrapguile1 (>= 1.3.4-1)/" debian/substvars.tmp > debian/substvars
	# mv debian/substvars.tmp debian/substvars
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

source diff:                                                                  
	@echo >&2 'source and diff are obsolete - use dpkg-source -b'; false

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install

 
